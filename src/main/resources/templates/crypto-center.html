<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="ì•”í˜¸í™”í ì •ë³´ ë° í† ë¡  ì»¤ë®¤ë‹ˆí‹°" />
    <meta name="author" content="Dae Lee" />
    <title>ğŸ’° ì•”í˜¸í™”í ì •ë³´ì„¼í„°</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
      crossorigin="anonymous"
    />
    <link href="/css/search-bar.css" rel="stylesheet" />
    
    <style>
      .crypto-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
      }
      
      .crypto-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .crypto-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      }
      
      .price-positive {
        color: #22c55e;
      }
      
      .price-negative {
        color: #ef4444;
      }
      
      .category-badge {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .category-badge:hover {
        transform: scale(1.05);
      }
      
      .market-cap-rank {
        background: linear-gradient(45deg, #f39c12, #e67e22);
        color: white;
        font-weight: bold;
      }
      
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>

  <body>
    <header id="header">
      í—¤ë” ì‚½ì…ë¶€
    </header>

    <!-- Hero Section -->
    <div class="crypto-hero">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="display-4 fw-bold">ğŸ’° ì•”í˜¸í™”í ì •ë³´ì„¼í„°</h1>
            <p class="lead">ì‹¤ì‹œê°„ ì•”í˜¸í™”í ê°€ê²© ì •ë³´ì™€ ì»¤ë®¤ë‹ˆí‹° í† ë¡ </p>
          </div>
          <div class="col-md-4 text-center">
            <div class="bg-white bg-opacity-10 rounded p-3">
              <h5>ğŸ“Š Market Status</h5>
              <div id="market-summary" class="market-summary">
                <div class="loading-spinner"></div>
                <span class="ms-2">ì‹œì¥ ì •ë³´ ë¡œë”© ì¤‘...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main class="container">
      <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">ğŸ·ï¸ ì•”í˜¸í™”í ì¹´í…Œê³ ë¦¬</h5>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap gap-2" id="crypto-categories">
                <span class="loading-spinner"></span>
                <span class="ms-2">ì¹´í…Œê³ ë¦¬ ë¡œë”© ì¤‘...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">ğŸ” ì•”í˜¸í™”í ê²€ìƒ‰</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <input
                    type="text"
                    class="form-control"
                    id="crypto-search"
                    placeholder="ì•”í˜¸í™”í ì´ë¦„ ë˜ëŠ” ì‹¬ë³¼ ê²€ìƒ‰ (ì˜ˆ: bitcoin, BTC)"
                  />
                </div>
                <div class="col-md-4">
                  <button class="btn btn-primary w-100" onclick="searchCryptocurrency()">
                    ê²€ìƒ‰
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì•”í˜¸í™”í ëª©ë¡ -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">ğŸ“ˆ ì‹¤ì‹œê°„ ì•”í˜¸í™”í ê°€ê²©</h5>
              <div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshPrices()">
                  ğŸ”„ ìƒˆë¡œê³ ì¹¨
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleView()">
                  <span id="view-toggle-text">ğŸ“Š ì°¨íŠ¸ë·°</span>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="row" id="crypto-list">
                <div class="col-12 text-center py-5">
                  <div class="loading-spinner mx-auto"></div>
                  <p class="mt-3 text-muted">ì•”í˜¸í™”í ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      <div class="row">
        <div class="col-12">
          <nav aria-label="Cryptocurrency pagination">
            <ul class="pagination justify-content-center" id="pagination">
              <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </ul>
          </nav>
        </div>
      </div>
    </main>

    <footer id="footer">
      <hr />
      í‘¸í„° ì‚½ì…ë¶€
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
      crossorigin="anonymous"
    ></script>

    <script>
      let currentPage = 0;
      let currentCategory = null;
      let isCardView = true;
      
      // ì‹œì¥ ìš”ì•½ ì •ë³´ ë¡œë“œ
      async function loadMarketSummary() {
        try {
          const response = await fetch('/api/crypto/prices?size=100');
          const data = await response.json();
          
          if (data.content) {
            const totalMarketCap = data.content.reduce((sum, crypto) => 
              sum + (crypto.marketCap || 0), 0);
            const positiveChanges = data.content.filter(crypto => 
              crypto.priceChangePercentage24h > 0).length;
            
            document.getElementById('market-summary').innerHTML = `
              <div class="row text-center">
                <div class="col-6">
                  <small>ì‹œê°€ì´ì•¡</small><br>
                  <strong>$${(totalMarketCap / 1e12).toFixed(2)}T</strong>
                </div>
                <div class="col-6">
                  <small>ìƒìŠ¹ì½”ì¸</small><br>
                  <strong>${positiveChanges}/${data.content.length}</strong>
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading market summary:', error);
        }
      }
      
      // ì¹´í…Œê³ ë¦¬ ë¡œë“œ
      async function loadCategories() {
        try {
          const response = await fetch('/api/crypto/categories');
          const categories = await response.json();
          
          const categoriesElement = document.getElementById('crypto-categories');
          if (categories && categories.length > 0) {
            categoriesElement.innerHTML = [
              '<span class="badge bg-primary category-badge me-2 mb-2" onclick="filterByCategory(null)">ì „ì²´</span>',
              ...categories.map(category => 
                `<span class="badge category-badge me-2 mb-2" 
                       style="background-color: ${category.color || '#6c757d'};" 
                       onclick="filterByCategory('${category.name}')" 
                       title="${category.description}">
                   ${category.name}
                 </span>`
              )
            ].join('');
          } else {
            categoriesElement.innerHTML = '<span class="text-muted">ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>';
          }
        } catch (error) {
          console.error('Error loading categories:', error);
          document.getElementById('crypto-categories').innerHTML = 
            '<span class="text-danger">ì¹´í…Œê³ ë¦¬ ë¡œë”© ì‹¤íŒ¨</span>';
        }
      }
      
      // ì•”í˜¸í™”í ëª©ë¡ ë¡œë“œ
      async function loadCryptocurrencies(page = 0, category = null) {
        try {
          let url = `/api/crypto/prices?page=${page}&size=20&sort=rank,asc`;
          if (category) {
            url = `/api/crypto/categories/${category}/cryptocurrencies?page=${page}&size=20`;
          }
          
          const response = await fetch(url);
          const data = await response.json();
          
          const cryptoListElement = document.getElementById('crypto-list');
          
          if (data.content && data.content.length > 0) {
            if (isCardView) {
              renderCardView(data.content);
            } else {
              renderTableView(data.content);
            }
            renderPagination(data.totalPages, page);
          } else {
            cryptoListElement.innerHTML = 
              '<div class="col-12 text-center"><p class="text-muted">ì•”í˜¸í™”í ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
          }
        } catch (error) {
          console.error('Error loading cryptocurrencies:', error);
          document.getElementById('crypto-list').innerHTML = 
            '<div class="col-12 text-center"><p class="text-danger">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</p></div>';
        }
      }
      
      // ì¹´ë“œ ë·° ë Œë”ë§
      function renderCardView(cryptocurrencies) {
        const cryptoListElement = document.getElementById('crypto-list');
        cryptoListElement.innerHTML = cryptocurrencies.map(crypto => {
          const changeClass = crypto.priceChangePercentage24h >= 0 ? 'price-positive' : 'price-negative';
          const changeSymbol = crypto.priceChangePercentage24h >= 0 ? 'â–²' : 'â–¼';
          const formattedPrice = crypto.currentPriceKrw ? 
            Number(crypto.currentPriceKrw).toLocaleString('ko-KR') + 'ì›' :
            '$' + Number(crypto.currentPrice || 0).toLocaleString('en-US');
          
          return `
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
              <div class="card crypto-card h-100">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="fw-bold mb-0">${crypto.symbol}</h6>
                    ${crypto.rank ? `<span class="badge market-cap-rank small">#${crypto.rank}</span>` : ''}
                  </div>
                  <p class="text-muted small mb-2">${crypto.name}</p>
                  <h5 class="fw-bold">${formattedPrice}</h5>
                  <p class="${changeClass} mb-0">
                    ${changeSymbol} ${Math.abs(crypto.priceChangePercentage24h || 0).toFixed(2)}%
                  </p>
                  ${crypto.marketCap ? 
                    `<small class="text-muted">ì‹œê°€ì´ì•¡: $${(crypto.marketCap / 1e9).toFixed(2)}B</small>` : 
                    ''
                  }
                </div>
                <div class="card-footer bg-transparent">
                  <button class="btn btn-sm btn-outline-primary w-100" 
                          onclick="viewCryptoDetail('${crypto.id}')">
                    ìƒì„¸ë³´ê¸°
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // í…Œì´ë¸” ë·° ë Œë”ë§ (êµ¬í˜„ ì˜ˆì •)
      function renderTableView(cryptocurrencies) {
        // TODO: í…Œì´ë¸” í˜•íƒœë¡œ ì•”í˜¸í™”í ëª©ë¡ í‘œì‹œ
        renderCardView(cryptocurrencies); // ì„ì‹œë¡œ ì¹´ë“œë·° ì‚¬ìš©
      }
      
      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      function renderPagination(totalPages, currentPageNum) {
        const paginationElement = document.getElementById('pagination');
        
        if (totalPages <= 1) {
          paginationElement.innerHTML = '';
          return;
        }
        
        let paginationHTML = '';
        
        // ì´ì „ í˜ì´ì§€
        if (currentPageNum > 0) {
          paginationHTML += `
            <li class="page-item">
              <a class="page-link" href="#" onclick="loadPage(${currentPageNum - 1})">ì´ì „</a>
            </li>
          `;
        }
        
        // í˜ì´ì§€ ë²ˆí˜¸ë“¤
        const startPage = Math.max(0, currentPageNum - 2);
        const endPage = Math.min(totalPages - 1, currentPageNum + 2);
        
        for (let i = startPage; i <= endPage; i++) {
          paginationHTML += `
            <li class="page-item ${i === currentPageNum ? 'active' : ''}">
              <a class="page-link" href="#" onclick="loadPage(${i})">${i + 1}</a>
            </li>
          `;
        }
        
        // ë‹¤ìŒ í˜ì´ì§€
        if (currentPageNum < totalPages - 1) {
          paginationHTML += `
            <li class="page-item">
              <a class="page-link" href="#" onclick="loadPage(${currentPageNum + 1})">ë‹¤ìŒ</a>
            </li>
          `;
        }
        
        paginationElement.innerHTML = paginationHTML;
      }
      
      // í˜ì´ì§€ ë¡œë“œ
      function loadPage(page) {
        currentPage = page;
        loadCryptocurrencies(page, currentCategory);
      }
      
      // ì¹´í…Œê³ ë¦¬ë³„ í•„í„°ë§
      function filterByCategory(category) {
        currentCategory = category;
        currentPage = 0;
        loadCryptocurrencies(0, category);
        
        // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.category-badge').forEach(badge => {
          badge.classList.remove('bg-primary');
          if (category === null && badge.textContent.trim() === 'ì „ì²´') {
            badge.classList.add('bg-primary');
          } else if (badge.textContent.trim() === category) {
            badge.classList.add('bg-primary');
          }
        });
      }
      
      // ì•”í˜¸í™”í ê²€ìƒ‰
      async function searchCryptocurrency() {
        const keyword = document.getElementById('crypto-search').value.trim();
        if (!keyword) {
          alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        try {
          const response = await fetch(`/api/crypto/prices/search?keyword=${encodeURIComponent(keyword)}`);
          const data = await response.json();
          
          if (data.content && data.content.length > 0) {
            renderCardView(data.content);
            renderPagination(data.totalPages, 0);
          } else {
            document.getElementById('crypto-list').innerHTML = 
              '<div class="col-12 text-center"><p class="text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
          }
        } catch (error) {
          console.error('Error searching cryptocurrency:', error);
          alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }
      
      // ê°€ê²© ìƒˆë¡œê³ ì¹¨
      function refreshPrices() {
        loadCryptocurrencies(currentPage, currentCategory);
        loadMarketSummary();
      }
      
      // ë·° ì „í™˜ (ì¹´ë“œë·° â†” í…Œì´ë¸”ë·°)
      function toggleView() {
        isCardView = !isCardView;
        document.getElementById('view-toggle-text').textContent = 
          isCardView ? 'ğŸ“Š ì°¨íŠ¸ë·°' : 'ğŸ“‹ ì¹´ë“œë·°';
        loadCryptocurrencies(currentPage, currentCategory);
      }
      
      // ì•”í˜¸í™”í ìƒì„¸ë³´ê¸°
      function viewCryptoDetail(cryptoId) {
        // TODO: ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ ë˜ëŠ” ëª¨ë‹¬ í‘œì‹œ
        console.log('View detail for:', cryptoId);
        alert(`${cryptoId} ìƒì„¸ë³´ê¸° ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë©ë‹ˆë‹¤.`);
      }
      
      // ê²€ìƒ‰ ì…ë ¥ì°½ ì—”í„°í‚¤ ì²˜ë¦¬
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('crypto-search').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            searchCryptocurrency();
          }
        });
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadMarketSummary();
        loadCategories();
        loadCryptocurrencies();
        
        // ìë™ ì—…ë°ì´íŠ¸ (3ë¶„ë§ˆë‹¤)
        setInterval(() => {
          refreshPrices();
        }, 180000);
      });
    </script>
  </body>
</html>