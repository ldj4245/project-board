<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="암호화폐 정보 및 토론 커뮤니티" />
    <meta name="author" content="Dae Lee" />
    <title>💰 암호화폐 정보센터</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
      crossorigin="anonymous"
    />
    <link href="/css/search-bar.css" rel="stylesheet" />
    
    <style>
      .crypto-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
      }
      
      .crypto-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .crypto-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      }
      
      .price-positive {
        color: #22c55e;
      }
      
      .price-negative {
        color: #ef4444;
      }
      
      .category-badge {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .category-badge:hover {
        transform: scale(1.05);
      }
      
      .market-cap-rank {
        background: linear-gradient(45deg, #f39c12, #e67e22);
        color: white;
        font-weight: bold;
      }
      
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>

  <body>
    <header id="header">
      헤더 삽입부
    </header>

    <!-- Hero Section -->
    <div class="crypto-hero">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="display-4 fw-bold">💰 암호화폐 정보센터</h1>
            <p class="lead">실시간 암호화폐 가격 정보와 커뮤니티 토론</p>
          </div>
          <div class="col-md-4 text-center">
            <div class="bg-white bg-opacity-10 rounded p-3">
              <h5>📊 Market Status</h5>
              <div id="market-summary" class="market-summary">
                <div class="loading-spinner"></div>
                <span class="ms-2">시장 정보 로딩 중...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main class="container">
      <!-- 카테고리 필터 -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">🏷️ 암호화폐 카테고리</h5>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap gap-2" id="crypto-categories">
                <span class="loading-spinner"></span>
                <span class="ms-2">카테고리 로딩 중...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 검색 섹션 -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">🔍 암호화폐 검색</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <input
                    type="text"
                    class="form-control"
                    id="crypto-search"
                    placeholder="암호화폐 이름 또는 심볼 검색 (예: bitcoin, BTC)"
                  />
                </div>
                <div class="col-md-4">
                  <button class="btn btn-primary w-100" onclick="searchCryptocurrency()">
                    검색
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 암호화폐 목록 -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">📈 실시간 암호화폐 가격</h5>
              <div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshPrices()">
                  🔄 새로고침
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleView()">
                  <span id="view-toggle-text">📊 차트뷰</span>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="row" id="crypto-list">
                <div class="col-12 text-center py-5">
                  <div class="loading-spinner mx-auto"></div>
                  <p class="mt-3 text-muted">암호화폐 정보를 불러오는 중...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 페이지네이션 -->
      <div class="row">
        <div class="col-12">
          <nav aria-label="Cryptocurrency pagination">
            <ul class="pagination justify-content-center" id="pagination">
              <!-- 페이지네이션 버튼들이 동적으로 생성됩니다 -->
            </ul>
          </nav>
        </div>
      </div>
    </main>

    <footer id="footer">
      <hr />
      푸터 삽입부
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
      crossorigin="anonymous"
    ></script>

    <script>
      let currentPage = 0;
      let currentCategory = null;
      let isCardView = true;
      
      // 시장 요약 정보 로드
      async function loadMarketSummary() {
        try {
          const response = await fetch('/api/crypto/prices?size=100');
          const data = await response.json();
          
          if (data.content) {
            const totalMarketCap = data.content.reduce((sum, crypto) => 
              sum + (crypto.marketCap || 0), 0);
            const positiveChanges = data.content.filter(crypto => 
              crypto.priceChangePercentage24h > 0).length;
            
            document.getElementById('market-summary').innerHTML = `
              <div class="row text-center">
                <div class="col-6">
                  <small>시가총액</small><br>
                  <strong>$${(totalMarketCap / 1e12).toFixed(2)}T</strong>
                </div>
                <div class="col-6">
                  <small>상승코인</small><br>
                  <strong>${positiveChanges}/${data.content.length}</strong>
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading market summary:', error);
        }
      }
      
      // 카테고리 로드
      async function loadCategories() {
        try {
          const response = await fetch('/api/crypto/categories');
          const categories = await response.json();
          
          const categoriesElement = document.getElementById('crypto-categories');
          if (categories && categories.length > 0) {
            categoriesElement.innerHTML = [
              '<span class="badge bg-primary category-badge me-2 mb-2" onclick="filterByCategory(null)">전체</span>',
              ...categories.map(category => 
                `<span class="badge category-badge me-2 mb-2" 
                       style="background-color: ${category.color || '#6c757d'};" 
                       onclick="filterByCategory('${category.name}')" 
                       title="${category.description}">
                   ${category.name}
                 </span>`
              )
            ].join('');
          } else {
            categoriesElement.innerHTML = '<span class="text-muted">카테고리를 불러올 수 없습니다</span>';
          }
        } catch (error) {
          console.error('Error loading categories:', error);
          document.getElementById('crypto-categories').innerHTML = 
            '<span class="text-danger">카테고리 로딩 실패</span>';
        }
      }
      
      // 암호화폐 목록 로드
      async function loadCryptocurrencies(page = 0, category = null) {
        try {
          let url = `/api/crypto/prices?page=${page}&size=20&sort=rank,asc`;
          if (category) {
            url = `/api/crypto/categories/${category}/cryptocurrencies?page=${page}&size=20`;
          }
          
          const response = await fetch(url);
          const data = await response.json();
          
          const cryptoListElement = document.getElementById('crypto-list');
          
          if (data.content && data.content.length > 0) {
            if (isCardView) {
              renderCardView(data.content);
            } else {
              renderTableView(data.content);
            }
            renderPagination(data.totalPages, page);
          } else {
            cryptoListElement.innerHTML = 
              '<div class="col-12 text-center"><p class="text-muted">암호화폐 정보를 불러올 수 없습니다</p></div>';
          }
        } catch (error) {
          console.error('Error loading cryptocurrencies:', error);
          document.getElementById('crypto-list').innerHTML = 
            '<div class="col-12 text-center"><p class="text-danger">데이터 로딩 실패</p></div>';
        }
      }
      
      // 카드 뷰 렌더링
      function renderCardView(cryptocurrencies) {
        const cryptoListElement = document.getElementById('crypto-list');
        cryptoListElement.innerHTML = cryptocurrencies.map(crypto => {
          const changeClass = crypto.priceChangePercentage24h >= 0 ? 'price-positive' : 'price-negative';
          const changeSymbol = crypto.priceChangePercentage24h >= 0 ? '▲' : '▼';
          const formattedPrice = crypto.currentPriceKrw ? 
            Number(crypto.currentPriceKrw).toLocaleString('ko-KR') + '원' :
            '$' + Number(crypto.currentPrice || 0).toLocaleString('en-US');
          
          return `
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
              <div class="card crypto-card h-100">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="fw-bold mb-0">${crypto.symbol}</h6>
                    ${crypto.rank ? `<span class="badge market-cap-rank small">#${crypto.rank}</span>` : ''}
                  </div>
                  <p class="text-muted small mb-2">${crypto.name}</p>
                  <h5 class="fw-bold">${formattedPrice}</h5>
                  <p class="${changeClass} mb-0">
                    ${changeSymbol} ${Math.abs(crypto.priceChangePercentage24h || 0).toFixed(2)}%
                  </p>
                  ${crypto.marketCap ? 
                    `<small class="text-muted">시가총액: $${(crypto.marketCap / 1e9).toFixed(2)}B</small>` : 
                    ''
                  }
                </div>
                <div class="card-footer bg-transparent">
                  <button class="btn btn-sm btn-outline-primary w-100" 
                          onclick="viewCryptoDetail('${crypto.id}')">
                    상세보기
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // 테이블 뷰 렌더링 (구현 예정)
      function renderTableView(cryptocurrencies) {
        // TODO: 테이블 형태로 암호화폐 목록 표시
        renderCardView(cryptocurrencies); // 임시로 카드뷰 사용
      }
      
      // 페이지네이션 렌더링
      function renderPagination(totalPages, currentPageNum) {
        const paginationElement = document.getElementById('pagination');
        
        if (totalPages <= 1) {
          paginationElement.innerHTML = '';
          return;
        }
        
        let paginationHTML = '';
        
        // 이전 페이지
        if (currentPageNum > 0) {
          paginationHTML += `
            <li class="page-item">
              <a class="page-link" href="#" onclick="loadPage(${currentPageNum - 1})">이전</a>
            </li>
          `;
        }
        
        // 페이지 번호들
        const startPage = Math.max(0, currentPageNum - 2);
        const endPage = Math.min(totalPages - 1, currentPageNum + 2);
        
        for (let i = startPage; i <= endPage; i++) {
          paginationHTML += `
            <li class="page-item ${i === currentPageNum ? 'active' : ''}">
              <a class="page-link" href="#" onclick="loadPage(${i})">${i + 1}</a>
            </li>
          `;
        }
        
        // 다음 페이지
        if (currentPageNum < totalPages - 1) {
          paginationHTML += `
            <li class="page-item">
              <a class="page-link" href="#" onclick="loadPage(${currentPageNum + 1})">다음</a>
            </li>
          `;
        }
        
        paginationElement.innerHTML = paginationHTML;
      }
      
      // 페이지 로드
      function loadPage(page) {
        currentPage = page;
        loadCryptocurrencies(page, currentCategory);
      }
      
      // 카테고리별 필터링
      function filterByCategory(category) {
        currentCategory = category;
        currentPage = 0;
        loadCryptocurrencies(0, category);
        
        // 카테고리 버튼 스타일 업데이트
        document.querySelectorAll('.category-badge').forEach(badge => {
          badge.classList.remove('bg-primary');
          if (category === null && badge.textContent.trim() === '전체') {
            badge.classList.add('bg-primary');
          } else if (badge.textContent.trim() === category) {
            badge.classList.add('bg-primary');
          }
        });
      }
      
      // 암호화폐 검색
      async function searchCryptocurrency() {
        const keyword = document.getElementById('crypto-search').value.trim();
        if (!keyword) {
          alert('검색어를 입력해주세요.');
          return;
        }
        
        try {
          const response = await fetch(`/api/crypto/prices/search?keyword=${encodeURIComponent(keyword)}`);
          const data = await response.json();
          
          if (data.content && data.content.length > 0) {
            renderCardView(data.content);
            renderPagination(data.totalPages, 0);
          } else {
            document.getElementById('crypto-list').innerHTML = 
              '<div class="col-12 text-center"><p class="text-muted">검색 결과가 없습니다</p></div>';
          }
        } catch (error) {
          console.error('Error searching cryptocurrency:', error);
          alert('검색 중 오류가 발생했습니다.');
        }
      }
      
      // 가격 새로고침
      function refreshPrices() {
        loadCryptocurrencies(currentPage, currentCategory);
        loadMarketSummary();
      }
      
      // 뷰 전환 (카드뷰 ↔ 테이블뷰)
      function toggleView() {
        isCardView = !isCardView;
        document.getElementById('view-toggle-text').textContent = 
          isCardView ? '📊 차트뷰' : '📋 카드뷰';
        loadCryptocurrencies(currentPage, currentCategory);
      }
      
      // 암호화폐 상세보기
      function viewCryptoDetail(cryptoId) {
        // TODO: 상세 페이지로 이동 또는 모달 표시
        console.log('View detail for:', cryptoId);
        alert(`${cryptoId} 상세보기 기능은 곧 구현됩니다.`);
      }
      
      // 검색 입력창 엔터키 처리
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('crypto-search').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            searchCryptocurrency();
          }
        });
        
        // 초기 데이터 로드
        loadMarketSummary();
        loadCategories();
        loadCryptocurrencies();
        
        // 자동 업데이트 (3분마다)
        setInterval(() => {
          refreshPrices();
        }, 180000);
      });
    </script>
  </body>
</html>