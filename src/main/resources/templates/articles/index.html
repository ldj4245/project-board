<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="Dae Lee" />
    <title>ê²Œì‹œíŒ í˜ì´ì§€</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
      crossorigin="anonymous"
    />
    <link href="/css/search-bar.css" rel="stylesheet" />
    <link href="/css/articles/table-header.css" rel="stylesheet" />
  </head>

  <body>
    <header id="header">
      í—¤ë” ì‚½ì…ë¶€
      <hr />
    </header>

    <main class="container">
      <!-- ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ìœ„ì ¯ -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-body p-0">
              <div
                class="d-flex justify-content-between align-items-center p-3 border-bottom"
              >
                <h5 class="mb-0">ğŸ”¥ ì‹¤ì‹œê°„ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</h5>
                <div>
                  <button
                    class="btn btn-sm btn-outline-primary me-2"
                    data-bs-toggle="modal"
                    data-bs-target="#coinSelectModal"
                  >
                    âš™ï¸ ì‹œì„¸í‘œ ì„¤ì •
                  </button>
                  <a href="/crypto" class="btn btn-sm btn-primary">ë”ë³´ê¸° â†’</a>
                </div>
              </div>

              <!-- ì½”ì¸ ì„ íƒ íƒ­ -->
              <div
                class="coin-tabs p-2 border-bottom bg-light"
                style="overflow-x: auto; white-space: nowrap"
              >
                <div id="coin-tabs-container"></div>
              </div>

              <!-- ì‹œì„¸í‘œ -->
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="premium-table">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 15%">ê±°ë˜ì†Œ</th>
                      <th style="width: 20%" class="text-end">
                        ì‹¤ì‹œê°„ ì‹œì„¸(KRW)
                      </th>
                      <th style="width: 20%" class="text-end">
                        ì‹¤ì‹œê°„ ì‹œì„¸(USD)
                      </th>
                      <th style="width: 15%" class="text-center">
                        24ì‹œê°„ ë³€ë™ë¥ 
                      </th>
                      <th style="width: 15%" class="text-center">
                        í•œêµ­ í”„ë¦¬ë¯¸ì—„
                      </th>
                      <th style="width: 15%" class="text-end">ê±°ë˜ëŸ‰</th>
                    </tr>
                  </thead>
                  <tbody id="premium-widget">
                    <tr>
                      <td colspan="6" class="text-center py-3">
                        <div
                          class="spinner-border spinner-border-sm text-primary"
                          role="status"
                        >
                          <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2 text-muted">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì½”ì¸ ì„ íƒ ëª¨ë‹¬ -->
      <div class="modal fade" id="coinSelectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">ê´€ì‹¬ ì½”ì¸ ê´€ë¦¬</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <!-- ì½”ì¸ ì¶”ê°€ ì„¹ì…˜ -->
              <div class="mb-4">
                <h6 class="mb-2">ìƒˆ ì½”ì¸ ì¶”ê°€</h6>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="new-coin-input"
                    placeholder="ì½”ì¸ ì‹¬ë³¼ ì…ë ¥ (ì˜ˆ: ENA, PEPE, SHIB)"
                    style="text-transform: uppercase"
                  />
                  <button
                    class="btn btn-primary"
                    type="button"
                    id="add-coin-btn"
                  >
                    <span
                      id="add-coin-spinner"
                      class="spinner-border spinner-border-sm d-none"
                      role="status"
                    ></span>
                    <span id="add-coin-text">ì¶”ê°€</span>
                  </button>
                </div>
                <small class="text-muted">
                  ğŸ’¡ Upbitê³¼ Binanceì—ì„œ ê±°ë˜ë˜ëŠ” ì½”ì¸ë§Œ ì¶”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤
                </small>
                <div id="add-coin-message" class="mt-2"></div>
              </div>

              <hr />

              <!-- ì„ íƒëœ ì½”ì¸ ëª©ë¡ -->
              <div>
                <h6 class="mb-2">ì„ íƒëœ ì½”ì¸ (ìµœëŒ€ 6ê°œ)</h6>
                <p class="text-muted small">ì½”ì¸ì„ í´ë¦­í•˜ì—¬ ì„ íƒ/í•´ì œí•˜ì„¸ìš”</p>
                <div id="coin-list" class="d-flex flex-wrap gap-2">
                  <!-- ì½”ì¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ì·¨ì†Œ
              </button>
              <button type="button" class="btn btn-primary" id="save-coins">
                ì €ì¥
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="card card-margin search-form">
          <div class="card-body p-0">
            <form id="search-form">
              <div class="row">
                <div class="col-12">
                  <div class="row no-gutters">
                    <div class="col-lg-3 col-md-3 col-sm-12 p-0">
                      <label for="search-type" hidden>ê²€ìƒ‰ ìœ í˜•</label>
                      <select
                        class="form-control"
                        id="search-type"
                        name="searchType"
                      >
                        <option>ì œëª©</option>
                        <option>ë³¸ë¬¸</option>
                        <option>id</option>
                        <option>ë‹‰ë„¤ì„</option>
                        <option>í•´ì‹œíƒœê·¸</option>
                      </select>
                    </div>
                    <div class="col-lg-8 col-md-6 col-sm-12 p-0">
                      <label for="search-value" hidden>ê²€ìƒ‰ì–´</label>
                      <input
                        type="text"
                        placeholder="ê²€ìƒ‰ì–´..."
                        class="form-control"
                        id="search-value"
                        name="searchValue"
                      />
                    </div>
                    <div class="col-lg-1 col-md-3 col-sm-12 p-0">
                      <button type="submit" class="btn btn-base">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="feather feather-search"
                        >
                          <circle cx="11" cy="11" r="8"></circle>
                          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="row">
        <table class="table" id="article-table">
          <thead>
            <tr>
              <th class="title col-5"><a>ì œëª©</a></th>
              <th class="hashtag col-2"><a>í•´ì‹œíƒœê·¸</a></th>
              <th class="user-id"><a>ì‘ì„±ì</a></th>
              <th class="view-count"><a>ì¡°íšŒìˆ˜</a></th>
              <th class="created-at"><a>ì‘ì„±ì¼</a></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="title"><a>ì²«ê¸€</a></td>
              <td class="hashtag">
                <span class="badge text-bg-secondary mx-1"
                  ><a class="text-reset">#java</a></span
                >
              </td>
              <td class="user-id">Lee</td>
              <td class="view-count">123</td>
              <td class="created-at"><time>2022-01-01</time></td>
            </tr>
            <tr>
              <td>ë‘ë²ˆì§¸ê¸€</td>
              <td>#spring</td>
              <td>Lee</td>
              <td>456</td>
              <td><time>2022-01-02</time></td>
            </tr>
            <tr>
              <td>ì„¸ë²ˆì§¸ê¸€</td>
              <td>#java</td>
              <td>Lee</td>
              <td>789</td>
              <td><time>2022-01-03</time></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row">
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
          <a class="btn btn-primary me-md-2" role="button" id="write-article"
            >ê¸€ì“°ê¸°</a
          >
        </div>
      </div>
      <div class="row">
        <nav id="pagination" aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <li class="page-item">
              <a class="page-link" href="#">Previous</a>
            </li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">Next</a></li>
          </ul>
        </nav>
      </div>
    </main>

    <footer id="footer">
      <hr />
      í‘¸í„° ì‚½ì…ë¶€
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
      crossorigin="anonymous"
    ></script>

    <!-- ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ìœ„ì ¯ JavaScript -->
    <script>
      // ì‚¬ìš© ê°€ëŠ¥í•œ ì½”ì¸ ëª©ë¡ (ê¸°ë³¸ ì œê³µ)
      const DEFAULT_AVAILABLE_COINS = [
        { symbol: "BTC", name: "ë¹„íŠ¸ì½”ì¸" },
        { symbol: "ETH", name: "ì´ë”ë¦¬ì›€" },
        { symbol: "XRP", name: "ë¦¬í”Œ" },
        { symbol: "SOL", name: "ì†”ë¼ë‚˜" },
        { symbol: "ADA", name: "ì—ì´ë‹¤" },
        { symbol: "DOGE", name: "ë„ì§€ì½”ì¸" },
        { symbol: "MATIC", name: "í´ë¦¬ê³¤" },
        { symbol: "DOT", name: "í´ì¹´ë‹·" },
        { symbol: "AVAX", name: "ì•„ë°œë€ì²´" },
        { symbol: "LINK", name: "ì²´ì¸ë§í¬" },
      ];

      // ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì½”ì¸ ëª©ë¡ (LocalStorageì— ì €ì¥)
      function getAvailableCoins() {
        const stored = localStorage.getItem("availableCoins");
        return stored ? JSON.parse(stored) : DEFAULT_AVAILABLE_COINS;
      }

      function saveAvailableCoins(coins) {
        localStorage.setItem("availableCoins", JSON.stringify(coins));
      }

      let AVAILABLE_COINS = getAvailableCoins();

      // ê¸°ë³¸ ì„ íƒ ì½”ì¸ (ìµœëŒ€ 6ê°œ)
      const DEFAULT_COINS = ["BTC", "ETH", "XRP", "SOL", "ADA"];

      // í˜„ì¬ ì„ íƒëœ ì½”ì¸
      let currentCoin = "BTC";

      // LocalStorageì—ì„œ ì„ íƒëœ ì½”ì¸ ê°€ì ¸ì˜¤ê¸°
      function getSelectedCoins() {
        const stored = localStorage.getItem("selectedCoins");
        return stored ? JSON.parse(stored) : DEFAULT_COINS;
      }

      // ì„ íƒëœ ì½”ì¸ ì €ì¥
      function saveSelectedCoins(coins) {
        localStorage.setItem("selectedCoins", JSON.stringify(coins));
      }

      // ì½”ì¸ íƒ­ ë Œë”ë§
      function renderCoinTabs() {
        const selectedCoins = getSelectedCoins();
        const tabsContainer = document.getElementById("coin-tabs-container");

        tabsContainer.innerHTML = selectedCoins
          .map((coin) => {
            const coinInfo = AVAILABLE_COINS.find((c) => c.symbol === coin);
            const isActive = coin === currentCoin;
            return `
            <button 
              class="btn btn-sm ${
                isActive ? "btn-primary" : "btn-outline-primary"
              } me-2 mb-1" 
              onclick="selectCoin('${coin}')"
              style="min-width: 80px;">
              <strong>${coin}</strong>
            </button>
          `;
          })
          .join("");
      }

      // ì½”ì¸ ì„ íƒ
      window.selectCoin = function (coin) {
        currentCoin = coin;
        renderCoinTabs();
        loadPremiumData();
      };

      // ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ë°ì´í„° ë¡œë“œ
      async function loadPremiumData() {
        try {
          const response = await fetch(`/api/premium/${currentCoin}`);

          if (!response.ok) {
            throw new Error("Failed to fetch");
          }

          const premium = await response.json();
          const coinInfo = AVAILABLE_COINS.find(
            (c) => c.symbol === currentCoin
          );

          const widget = document.getElementById("premium-widget");

          // êµ­ë‚´ ê±°ë˜ì†Œë“¤
          const domesticExchanges = [
            {
              name: premium.domesticExchange,
              priceKRW: premium.domesticPrice,
              priceUSD: premium.domesticPrice / premium.exchangeRate,
              premium: premium.premiumPercentage,
              changePercent: premium.changePercent24h || 0,
              volume: premium.volume24h || 0,
            },
          ];

          // í•´ì™¸ ê±°ë˜ì†Œë“¤ (ë°”ì´ë‚¸ìŠ¤ë„ ë³€ë™ë¥ ê³¼ ê±°ë˜ëŸ‰ í‘œì‹œ)
          const internationalExchanges = [
            {
              name: premium.internationalExchange,
              priceKRW: premium.internationalPriceInKrw,
              priceUSD: premium.internationalPrice,
              premium: 0,
              changePercent: premium.internationalChangePercent24h || 0,
              volume: premium.internationalVolume24h || 0,
            },
          ];

          widget.innerHTML = [
            ...domesticExchanges.map((ex) => {
              const isPositive = ex.premium >= 0;
              const premiumColor = isPositive ? "text-danger" : "text-primary";
              const premiumSign = isPositive ? "+" : "";

              // ë³€ë™ë¥  ìƒ‰ìƒ ë° ë¶€í˜¸
              const changePercent = ex.changePercent;
              const changeIsPositive = changePercent >= 0;
              const changeColor = changeIsPositive
                ? "text-danger"
                : "text-primary";
              const changeSign = changeIsPositive ? "+" : "";

              // ê±°ë˜ëŸ‰ í¬ë§· (ì›í™” ê°€ì¹˜ë¡œ ê³„ì‚°)
              const volume = ex.volume || 0;
              const volumeInKRW = volume * ex.priceKRW; // ì½”ì¸ ìˆ˜ëŸ‰ * ê°€ê²© = ì›í™” ê°€ì¹˜
              const volumeInBillion = (volumeInKRW / 100000000).toFixed(0); // ì–µ ë‹¨ìœ„

              return `
                <tr>
                  <td>
                    <strong>${ex.name}</strong>
                    <span class="badge bg-success ms-1">í•œêµ­</span>
                  </td>
                  <td class="text-end">
                    <strong>${ex.priceKRW.toLocaleString()}</strong> KRW
                  </td>
                  <td class="text-end text-muted">
                    ${ex.priceUSD.toLocaleString(undefined, {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2,
                    })} USD
                  </td>
                  <td class="text-center">
                    <strong class="${changeColor}">${changeSign}${changePercent.toFixed(
                2
              )}%</strong>
                  </td>
                  <td class="text-center">
                    <strong class="${premiumColor}">${premiumSign}${ex.premium.toFixed(
                2
              )}%</strong>
                  </td>
                  <td class="text-end">
                    <span class="text-muted">${volumeInBillion}ì–µ</span>
                  </td>
                </tr>
              `;
            }),
            ...internationalExchanges.map((ex) => {
              // ë°”ì´ë‚¸ìŠ¤ ë³€ë™ë¥  ë° ê±°ë˜ëŸ‰
              const changePercent = ex.changePercent;
              const hasChange = changePercent !== 0;
              const changeIsPositive = changePercent >= 0;
              const changeColor = changeIsPositive
                ? "text-danger"
                : "text-primary";
              const changeSign = changeIsPositive ? "+" : "";

              // ê±°ë˜ëŸ‰ í¬ë§· (ì›í™” ê°€ì¹˜ë¡œ ê³„ì‚°)
              const volume = ex.volume || 0;
              const volumeInKRW = volume * ex.priceUSD * premium.exchangeRate; // USD ê±°ë˜ëŸ‰ì„ KRWë¡œ í™˜ì‚°
              const volumeInBillion = (volumeInKRW / 100000000).toFixed(0); // ì–µ ë‹¨ìœ„
              const hasVolume = volume > 0;

              return `
                <tr class="table-light">
                  <td>
                    <strong>${ex.name}</strong>
                    <span class="badge bg-primary ms-1">í•´ì™¸</span>
                  </td>
                  <td class="text-end text-muted">
                    ${ex.priceKRW.toLocaleString(undefined, {
                      minimumFractionDigits: 0,
                      maximumFractionDigits: 0,
                    })} KRW
                  </td>
                  <td class="text-end">
                    <strong>${ex.priceUSD.toLocaleString(undefined, {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2,
                    })}</strong> USD
                  </td>
                  <td class="text-center">
                    ${
                      hasChange
                        ? `<strong class="${changeColor}">${changeSign}${changePercent.toFixed(
                            2
                          )}%</strong>`
                        : '<span class="badge bg-secondary">-</span>'
                    }
                  </td>
                  <td class="text-center text-muted">
                    ê¸°ì¤€ê°€
                  </td>
                  <td class="text-end text-muted">
                    ${hasVolume ? `${volumeInBillion}ì–µ` : "-"}
                  </td>
                </tr>
              `;
            }),
          ].join("");
        } catch (error) {
          console.error("Failed to load premium data:", error);
          document.getElementById("premium-widget").innerHTML =
            '<tr><td colspan="6" class="text-center py-3 text-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        }
      }

      // ì½”ì¸ í´ë¦­ í•¸ë“¤ëŸ¬ (í•œ ë²ˆë§Œ ì •ì˜)
      function handleCoinListClick(e) {
        const btn = e.target.closest(".coin-item");
        const removeBtn = e.target.closest(".remove-coin-btn");

        // ì‚­ì œ ë²„íŠ¼ í´ë¦­
        if (removeBtn) {
          e.stopPropagation();
          const symbol = removeBtn.dataset.symbol;
          removeCoin(symbol);
          return;
        }

        // ì½”ì¸ ì„ íƒ ë²„íŠ¼ í´ë¦­
        if (btn) {
          const symbol = btn.dataset.symbol;
          const currentSelected = getSelectedCoins();

          if (currentSelected.includes(symbol)) {
            // ì´ë¯¸ ì„ íƒë¨ -> í•´ì œ
            const newSelected = currentSelected.filter((s) => s !== symbol);
            if (newSelected.length === 0) {
              alert("ìµœì†Œ 1ê°œì˜ ì½”ì¸ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
              return;
            }
            // LocalStorage ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            saveSelectedCoins(newSelected);
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-outline-secondary");
          } else {
            // ì„ íƒë˜ì§€ ì•ŠìŒ -> ì„ íƒ
            if (currentSelected.length >= 6) {
              alert("ìµœëŒ€ 6ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
              return;
            }
            // LocalStorage ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            const newSelected = [...currentSelected, symbol];
            saveSelectedCoins(newSelected);
            btn.classList.remove("btn-outline-secondary");
            btn.classList.add("btn-primary");
          }
        }
      }

      // ì½”ì¸ ì„ íƒ ëª¨ë‹¬ ì´ˆê¸°í™”
      function initCoinSelectModal() {
        // í•­ìƒ ìµœì‹  ë°ì´í„° ë¡œë“œ
        AVAILABLE_COINS = getAvailableCoins();
        const selectedCoins = getSelectedCoins();
        const coinList = document.getElementById("coin-list");

        // ì½”ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ë¡œ í‘œì‹œ
        coinList.innerHTML = AVAILABLE_COINS.map((coin) => {
          const isSelected = selectedCoins.includes(coin.symbol);
          const isUserAdded = !DEFAULT_AVAILABLE_COINS.find(
            (c) => c.symbol === coin.symbol
          );
          return `
            <div class="d-inline-block position-relative mb-2 me-2">
              <button 
                class="btn ${
                  isSelected ? "btn-primary" : "btn-outline-secondary"
                } coin-item" 
                data-symbol="${coin.symbol}">
                <strong>${coin.symbol}</strong>
                ${
                  coin.name
                    ? `<small class="text-muted ms-1">${coin.name}</small>`
                    : ""
                }
              </button>
              ${
                isUserAdded
                  ? `<button class="btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle remove-coin-btn" 
                        data-symbol="${coin.symbol}"
                        style="width: 20px; height: 20px; padding: 0; line-height: 1; font-size: 12px; transform: translate(50%, -50%);"
                        title="ì‚­ì œ">Ã—</button>`
                  : ""
              }
            </div>
          `;
        }).join("");

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ì¬ë“±ë¡
        coinList.removeEventListener("click", handleCoinListClick);
        coinList.addEventListener("click", handleCoinListClick);
      }

      // ì½”ì¸ ì‚­ì œ (ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì½”ì¸ë§Œ)
      function removeCoin(symbol) {
        if (confirm(`${symbol} ì½”ì¸ì„ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          // availableCoinsì—ì„œ ì œê±°
          AVAILABLE_COINS = AVAILABLE_COINS.filter((c) => c.symbol !== symbol);
          saveAvailableCoins(AVAILABLE_COINS);

          // ì„ íƒëœ ì½”ì¸ì—ì„œë„ ì œê±°
          const selectedCoins = getSelectedCoins();
          const newSelected = selectedCoins.filter((s) => s !== symbol);
          saveSelectedCoins(newSelected);

          // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì½”ì¸ì´ë©´ ë‹¤ë¥¸ ì½”ì¸ìœ¼ë¡œ ë³€ê²½
          if (currentCoin === symbol && newSelected.length > 0) {
            currentCoin = newSelected[0];
            renderCoinTabs();
            loadPremiumData();
          }

          // ëª¨ë‹¬ ì¬ë Œë”ë§
          initCoinSelectModal();
        }
      }

      // ìƒˆ ì½”ì¸ ì¶”ê°€
      document
        .getElementById("add-coin-btn")
        .addEventListener("click", async function () {
          const input = document.getElementById("new-coin-input");
          const symbol = input.value.trim().toUpperCase();
          const messageDiv = document.getElementById("add-coin-message");
          const spinner = document.getElementById("add-coin-spinner");
          const btnText = document.getElementById("add-coin-text");

          if (!symbol) {
            messageDiv.innerHTML =
              '<div class="alert alert-warning py-2">ì½”ì¸ ì‹¬ë³¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
            return;
          }

          // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if (AVAILABLE_COINS.find((c) => c.symbol === symbol)) {
            messageDiv.innerHTML =
              '<div class="alert alert-info py-2">ì´ë¯¸ ëª©ë¡ì— ìˆëŠ” ì½”ì¸ì…ë‹ˆë‹¤.</div>';
            return;
          }

          // ë¡œë”© ì‹œì‘
          spinner.classList.remove("d-none");
          btnText.textContent = "í™•ì¸ ì¤‘...";
          this.disabled = true;
          messageDiv.innerHTML = "";

          try {
            // ì½”ì¸ ìœ íš¨ì„± ê²€ì¦
            const response = await fetch(`/api/premium/validate/${symbol}`);
            const isValid = await response.json();

            if (isValid) {
              // ìœ íš¨í•œ ì½”ì¸ -> ì¶”ê°€
              AVAILABLE_COINS.push({ symbol, name: "" });
              saveAvailableCoins(AVAILABLE_COINS);

              messageDiv.innerHTML = `<div class="alert alert-success py-2">âœ… ${symbol} ì½”ì¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</div>`;
              input.value = "";

              // ëª¨ë‹¬ ì¬ë Œë”ë§
              initCoinSelectModal();

              setTimeout(() => {
                messageDiv.innerHTML = "";
              }, 3000);
            } else {
              messageDiv.innerHTML = `<div class="alert alert-danger py-2">âŒ ${symbol} ì½”ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Upbitê³¼ Binance ëª¨ë‘ì—ì„œ ê±°ë˜ë˜ëŠ” ì½”ì¸ë§Œ ì¶”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>`;
            }
          } catch (error) {
            console.error("Error validating coin:", error);
            messageDiv.innerHTML =
              '<div class="alert alert-danger py-2">âŒ ì½”ì¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
          } finally {
            // ë¡œë”© ì¢…ë£Œ
            spinner.classList.add("d-none");
            btnText.textContent = "ì¶”ê°€";
            this.disabled = false;
          }
        });

      // Enter í‚¤ë¡œë„ ì¶”ê°€ ê°€ëŠ¥
      document
        .getElementById("new-coin-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            document.getElementById("add-coin-btn").click();
          }
        });

      // ì €ì¥ ë²„íŠ¼ í´ë¦­
      document
        .getElementById("save-coins")
        .addEventListener("click", function () {
          const coinButtons = document.querySelectorAll(
            "#coin-list .coin-item"
          );
          const selectedCoins = Array.from(coinButtons)
            .filter((btn) => btn.classList.contains("btn-primary"))
            .map((btn) => btn.dataset.symbol);

          if (selectedCoins.length === 0) {
            alert("ìµœì†Œ 1ê°œì˜ ì½”ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }

          saveSelectedCoins(selectedCoins);

          // í˜„ì¬ ì„ íƒëœ ì½”ì¸ì´ ìƒˆë¡œìš´ ëª©ë¡ì— ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì½”ì¸ìœ¼ë¡œ ë³€ê²½
          if (!selectedCoins.includes(currentCoin)) {
            currentCoin = selectedCoins[0];
          }

          renderCoinTabs();
          loadPremiumData();

          // ëª¨ë‹¬ ë‹«ê¸°
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("coinSelectModal")
          );
          modal.hide();
        });

      // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ ì´ˆê¸°í™”
      document
        .getElementById("coinSelectModal")
        .addEventListener("show.bs.modal", initCoinSelectModal);

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      renderCoinTabs();
      loadPremiumData();

      // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
      setInterval(loadPremiumData, 30000);
    </script>
  </body>
</html>
